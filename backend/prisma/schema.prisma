// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Core User Models
// ============================================================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  role            Role      @default(STUDENT)
  institutionId   String
  avatarUrl       String?
  language        String    @default("en")
  theme           Theme     @default(DARK)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  institution     Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  student         Student?
  teacherClasses  TeacherClass[]
  feedbackGiven   Feedback[] @relation("TeacherFeedback")
  grievancesAssigned Grievance[] @relation("AssignedTo")
  gamificationEvents GamificationEvent[]
  chatMessages    ChatMessage[]
  auditLogs       AuditLog[]

  @@map("users")
}

model Institution {
  id        String    @id @default(cuid())
  name      String
  domain    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  users     User[]
  classes   Class[]

  @@map("institutions")
}

// ============================================================================
// Student-Specific Models
// ============================================================================

model Student {
  id                String    @id @default(cuid())
  userId            String    @unique
  githubUsername    String?
  githubConnected   Boolean   @default(false)
  currentPoints     Int       @default(0)
  currentLevel      Int       @default(1)
  currentStreak     Int       @default(0)
  riskScore         Float     @default(0) // 0-100
  riskLevel         RiskLevel @default(LOW)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions       Submission[]
  feedbackReceived  Feedback[] @relation("StudentFeedback")
  grievances        Grievance[] @relation("StudentGrievance")
  badges            StudentBadge[]
  riskPredictions   RiskPrediction[]
  chatMessages      ChatMessage[]
  gamificationEvents GamificationEvent[]

  @@map("students")
}

// ============================================================================
// Class & Assignment Models
// ============================================================================

model Class {
  id              String    @id @default(cuid())
  name            String
  description     String?
  institutionId   String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  institution     Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  teachers        TeacherClass[]
  assignments     Assignment[]

  @@map("classes")
}

model TeacherClass {
  id        String    @id @default(cuid())
  userId    String
  classId   String
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  class     Class     @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@map("teacher_classes")
}

model Assignment {
  id          String    @id @default(cuid())
  classId     String
  title       String
  description String?
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  class       Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@map("assignments")
}

// ============================================================================
// Submission & Feedback Models
// ============================================================================

model Submission {
  id                String    @id @default(cuid())
  studentId         String
  assignmentId      String
  githubUrl         String?
  codeQualityScore  Float     @default(0)
  complexityScore   Float     @default(0)
  submittedAt       DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  student           Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignment        Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  feedback          Feedback[]

  @@map("submissions")
}

model Feedback {
  id              String    @id @default(cuid())
  submissionId    String
  teacherId       String
  studentId       String
  aiSuggested     Boolean   @default(false)
  content         String
  rating          Int?      // 1-5
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  submission      Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  teacher         User      @relation("TeacherFeedback", fields: [teacherId], references: [id], onDelete: Cascade)
  student         Student   @relation("StudentFeedback", fields: [studentId], references: [id], onDelete: Cascade)

  @@map("feedback")
}

// ============================================================================
// Grievance Models
// ============================================================================

model Grievance {
  id            String        @id @default(cuid())
  studentId     String
  category      GrievanceCategory
  severity      GrievanceSeverity
  description   String
  status        GrievanceStatus @default(OPEN)
  assignedToId  String?
  resolution    String?
  createdAt     DateTime      @default(now())
  resolvedAt    DateTime?
  updatedAt     DateTime      @updatedAt

  // Relations
  student       Student       @relation("StudentGrievance", fields: [studentId], references: [id], onDelete: Cascade)
  assignedTo    User?         @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  auditTrail    GrievanceAuditLog[]

  @@map("grievances")
}

model GrievanceAuditLog {
  id          String    @id @default(cuid())
  grievanceId String
  action      String
  details     String?
  createdAt   DateTime  @default(now())

  // Relations
  grievance   Grievance @relation(fields: [grievanceId], references: [id], onDelete: Cascade)

  @@map("grievance_audit_logs")
}

// ============================================================================
// Gamification Models
// ============================================================================

model Badge {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  iconUrl     String?
  criteria    String
  rarity      BadgeRarity @default(COMMON)
  createdAt   DateTime  @default(now())

  // Relations
  students    StudentBadge[]
  events      GamificationEvent[]

  @@map("badges")
}

model StudentBadge {
  id        String    @id @default(cuid())
  studentId String
  badgeId   String
  unlockedAt DateTime @default(now())

  // Relations
  student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge     Badge     @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeId])
  @@map("student_badges")
}

model GamificationEvent {
  id              String    @id @default(cuid())
  studentId       String
  userId          String
  eventType       GamificationEventType
  pointsAwarded   Int       @default(0)
  badgeUnlockedId String?
  createdAt       DateTime  @default(now())

  // Relations
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeUnlocked   Badge?    @relation(fields: [badgeUnlockedId], references: [id], onDelete: SetNull)

  @@map("gamification_events")
}

// ============================================================================
// Risk Prediction Models
// ============================================================================

model RiskPrediction {
  id                    String    @id @default(cuid())
  studentId             String
  riskScore             Float     // 0-100
  riskLevel             RiskLevel
  submissionFrequency   Float     @default(0)
  codeQualityTrend      Float     @default(0)
  engagementScore       Float     @default(0)
  feedbackResponseTime  Float     @default(0)
  confidence            Float     // 0-1
  predictedAt           DateTime  @default(now())
  createdAt             DateTime  @default(now())

  // Relations
  student               Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("risk_predictions")
}

// ============================================================================
// Chatbot Models
// ============================================================================

model ChatMessage {
  id        String    @id @default(cuid())
  userId    String
  studentId String?
  content   String
  role      ChatRole  // 'user' or 'assistant'
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  student   Student?  @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@map("chat_messages")
}

// ============================================================================
// Audit Trail Models
// ============================================================================

model AuditLog {
  id        String    @id @default(cuid())
  userId    String
  action    String
  resource  String
  details   String?
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// ============================================================================
// Enums
// ============================================================================

enum Role {
  STUDENT
  TEACHER
  MENTOR
  ADMIN
}

enum Theme {
  DARK
  LIGHT
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum GrievanceCategory {
  GRADE
  FEEDBACK
  FAIRNESS
  OTHER
}

enum GrievanceSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum GrievanceStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum GamificationEventType {
  SUBMISSION
  FEEDBACK
  ACHIEVEMENT
  STREAK
}

enum ChatRole {
  USER
  ASSISTANT
}
